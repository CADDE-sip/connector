# WebApp開発ガイドライン
本ドキュメントについて：<br>
 本ドキュメントはCADDEの認証機能を利用したWebappを自作するためのガイドラインです。

## 認証ログインシーケンス図
認証ログイン、コネクタ接続のシーケンス図および各処理の説明を示します。<br>
![Alt text](png/authn.png?raw=true "Title")

1. データ利用者はWebAppへアクセスを行います。
2. WebAppの画面をデータ利用者に表示します。
3. データ利用者はWebAppの画面から認証を開始します。
4. データ利用者はkeycloakログイン画面URLの作成要求を行います。
5. 認可コードのすり替えを防ぐためにステート（ランダム文字列）を作成します。
6. keycloak画面への認可リクエストURLを作成します。
7. 認可リクエストURLをデータ利用者に送信します。
8. データ利用者は返却された認可リクエストURLにアクセスを行います。<br>
    ・認可リクエストURLの仕様

    |パス                                                                   |メソッド             |クエリパラメータ                                                   |
    |:--------------------------------------------------------------------- |:------------------ |:--------------------------------------------------------------  |
    |認証機能のアクセスURL/realms/authentication/protocol/openid-connect/auth |GET                | クライアントID、レスポンスモード、レスポンスタイプ、スコープ、ステート |


    |パラメータ　　　　　　　          |概要                                                                      |
    |:------------------------------ |:-----------------------------------------------------------------------  |
    |スコープ : scope                 |トークンを取得する際に権限の範囲を指定<br>値はopenid固定                      |
    |レスポンスタイプ : response_type |グラントタイプ指定するものでありここでは認可コードグラントを指定<br>値はcode固定 |
    |クライアントID : client_id       |認証機能がクライアントを識別するためのID                                      |
    |リダイレクトURI : redirect_uri 　|認証機能画面からWebApp画面に戻る際のURI　　　　　　　　　　　　　　             |
    |ステート : state                |認可コードのすり替え（クロスサイトリクエストフォージェリ）を防ぐためのランダム値  |
    |レスポンスモード : response_mode |パラメータの受け渡し方法を指定するもの<br>値はfragment固定                     |

    <br>

9. データ利用者にkeycloackの認証画面を表示します。<br>
![Alt text](png/keycloak.png?raw=true "Title")

10. データ利用者はユーザ名、パスワードを認証機能へ送信します。
11. データ利用者にワンタイムパスワード認証画面を表示します。
12. データ利用者はワンタイムパスワードを送信します。
13. 認証機能は認可コード、ステート、リダイレクトURIをデータ利用者に返します。
14. データ利用者は13で返却されているリダイレクトURIにアクセスし、認可コード、ステートを送信します。
15. ステート検証を行います。
16. 下記のAPIよりデータ利用者がWebAppを利用してCADDEによって認証し、認証トークンの要求を行います。

    |パス                                                       |メソッド             |パラメータ                  |
    |:--------------------------------------------------------- |:------------------ |:------------------------  |
    |認証機能のアクセスURL/cadde/api/v4/token/authenticationCode  |POST                | 認可コード、リダイレクトURI |

    |パラメータ　　　　　　　          |概要                                                                      |
    |:------------------------------ |:----------------------------------------------------------------------- |
    |リダイレクトURI : redirect_uri 　|認証機能画面からWebApp画面に戻る際のURI　　　　　　　　　　　　　　            |
    |認可コード : code                |認可コードグラントにおいてアクセストークンを取得するために必要な短命のトークン  |

    <br>

17. 認証トークンの発行を行います。
18. 認証トークン取得の結果として認証トークンをWebAppへ送信します。
19. WebAppで取得した認証トークンを保持します。
20. ログインセッションの作成を行います。
21. 認証が完了し、認証済みのWebApp画面へ遷移します。
22. データ利用者はカタログ検索要求（検索文字列）を行います。
23. 下記APIよりコネクタへカタログの要求を行います。

    |パス                                                   |メソッド             |パラメータ                             |
    |:----------------------------------------------------- |:------------------ |:-----------------------------------  |
    |利用者コネクタのアクセスURL/cadde/api/v4/catalog         |GET                 | 検索文字列 、認証トークン              |

    |パラメータ　　　　　　　          |概要                                                                      |
    |:------------------------------ |:-----------------------------------------------------------------------  |
    |検索文字列                       |カタログ検索を行う検索文字列                                                |
    |認証トークン : access_token      |CADDE認証機能が発行するアクセストークン       　                             |

    <br>


24. カタログ検索の結果をWebAppへ返却します。
25. カタログ検索の結果をデータ利用者へ表示します。
26. データ利用者はデータ交換要求（リソースURL）を行います。
27. 下記APIよりコネクタへデータ交換の要求を行います。

    |パス                                                   |メソッド             |パラメータ                             |
    |:----------------------------------------------------- |:------------------ |:-----------------------------------  |
    |利用者コネクタのアクセスURL/cadde/api/v4/file            |GET                 | リソースURL 、認証トークン             |

    |パラメータ　　　　　　　          |概要                                                                      |
    |:------------------------------ |:-----------------------------------------------------------------------  |
    |リソースURL : resource_url       |取得するデータのリソースURL                  　                             |
    |認証トークン : access_token      |CADDE認証機能が発行するアクセストークン       　                             |

    <br>

28. 下記APIよりトークン検証を行います。

    |パス                                                       |メソッド             |パラメータ                 |
    |:-------------------------------------------------------- |:------------------ |:------------------------- |
    |認証機能のアクセスURL/cadde/api/v4/token/intorospect        |POST                | 認証トークン　　　　　　　  |

    |パラメータ　　　　　　　          |概要                                                                      |
    |:------------------------------ |:-----------------------------------------------------------------------  |
    |認証トークン : access_token      |CADDE認証機能が発行するアクセストークン       　                             |

    <br>

29. データ交換の結果をWebAppへ返却します。
30. データ交換の結果をデータ利用者へ表示します。

# 参考

## API一覧
シーケンス図にはない認証APIの一覧を示します。
|パス                                                       |メソッド             |パラメータ                  |
|:-------------------------------------------------------- |:------------------ |:-------------------------  |
|認証機能のアクセスURL/cadde/api/v4/token/intorospect        |POST                | 認証トークン　　　　　　　　 |

|パラメータ　　　　　　　          |概要                                                                      |
|:------------------------------ |:-----------------------------------------------------------------------  |
|認証トークン : access_token      |CADDE認証機能が発行するアクセストークン       　                             |

|パス                                   |メソッド             |概要                                            |
|:------------------------------------- |:------------------ |:--------------------------------------------  |
|/cadde/api/v4/token/refresh            |POST                | 有効期限が切れる前にアクセストークンを更新します   |

